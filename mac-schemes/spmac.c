#include "contiki-net.h"
#include "tinydtls.h"
#include "dtls-hmac.h"

#include <string.h>

#include "spmac.h"

#if(TAGLEN==4)
    const char rulers[64][7] = {
        {0, 1, 3, 7, 8, 11, 13},
        {0, 1, 4, 6, 10, 11, 13},
        {0, 2, 3, 7, 9, 12, 13},
        {0, 2, 5, 6, 10, 12, 13},
        {0, 1, 2, 5, 7, 11, 14},
        {0, 1, 2, 5, 8, 10, 14},
        {0, 1, 2, 5, 9, 12, 14},
        {0, 1, 2, 6, 9, 12, 14},
        {0, 1, 3, 5, 10, 11, 14},
        {0, 1, 3, 7, 11, 13, 14},
        {0, 1, 3, 8, 9, 12, 14},
        {0, 1, 3, 8, 10, 13, 14},
        {0, 1, 4, 6, 8, 13, 14},
        {0, 1, 4, 6, 11, 12, 14},
        {0, 1, 4, 7, 9, 13, 14},
        {0, 1, 4, 9, 10, 12, 14},
        {0, 1, 4, 9, 11, 13, 14},
        {0, 1, 5, 7, 10, 13, 14},
        {0, 1, 5, 9, 11, 12, 14},
        {0, 1, 6, 8, 10, 11, 14},
        {0, 1, 6, 9, 10, 12, 14},
        {0, 2, 3, 5, 9, 13, 14},
        {0, 2, 3, 6, 7, 12, 14},
        {0, 2, 3, 7, 11, 12, 14},
        {0, 2, 3, 8, 10, 13, 14},
        {0, 2, 4, 5, 8, 13, 14},
        {0, 2, 4, 5, 10, 11, 14},
        {0, 2, 5, 6, 11, 13, 14},
        {0, 2, 5, 8, 12, 13, 14},
        {0, 2, 5, 9, 12, 13, 14},
        {0, 2, 6, 9, 12, 13, 14},
        {0, 2, 7, 8, 11, 12, 14},
        {0, 3, 4, 6, 8, 13, 14},
        {0, 3, 4, 9, 10, 12, 14},
        {0, 3, 4, 9, 11, 13, 14},
        {0, 3, 7, 9, 12, 13, 14},
        {0, 4, 6, 9, 12, 13, 14},
        {0, 1, 3, 5, 9, 14, 15},
        {0, 2, 5, 6, 12, 13, 15},
        {0, 3, 4, 6, 8, 14, 15},
        {0, 2, 3, 9, 10, 13, 15},
        {0, 3, 6, 8, 13, 14, 15},
        {0, 1, 5, 9, 12, 14, 15},
        {0, 1, 7, 9, 11, 12, 15},
        {0, 3, 6, 8, 10, 14, 15},
        {0, 1, 2, 7, 9, 12, 15},
        {0, 1, 5, 7, 12, 13, 15},
        {0, 2, 3, 6, 7, 13, 15},
        {0, 1, 3, 8, 12, 14, 15},
        {0, 2, 4, 7, 10, 14, 15},
        {0, 1, 4, 8, 10, 13, 15},
        {0, 2, 3, 8, 10, 14, 15},
        {0, 2, 7, 10, 13, 14, 15},
        {0, 1, 2, 7, 10, 13, 15},
        {0, 1, 3, 5, 11, 12, 15},
        {0, 3, 5, 9, 13, 14, 15},
        {0, 2, 5, 9, 13, 14, 15},
        {0, 4, 6, 11, 12, 14, 15},
        {0, 1, 2, 6, 8, 11, 15},
        {0, 1, 2, 5, 8, 13, 15},
        {0, 1, 4, 6, 12, 13, 15},
        {0, 6, 7, 10, 12, 14, 15},
        {0, 1, 4, 6, 8, 9, 15},
        {0, 2, 6, 11, 12, 14, 15}
    };
#elif(TAGLEN==2)
    const char rulers[64][8] = {
	    {0, 1, 2, 6, 10, 13, 16, 18},
	    {0, 1, 3, 7, 9, 14, 17, 18},
	    {0, 1, 3, 8, 12, 14, 17, 18},
	    {0, 1, 4, 6, 10, 15, 17, 18},
	    {0, 1, 4, 9, 11, 15, 17, 18},
	    {0, 2, 5, 8, 12, 16, 17, 18},
	    {0, 1, 2, 5, 8, 13, 15, 19},
	    {0, 1, 2, 5, 9, 11, 16, 19},
	    {0, 1, 2, 5, 10, 12, 16, 19},
	    {0, 1, 2, 5, 10, 13, 17, 19},
	    {0, 1, 2, 6, 9, 12, 17, 19},
	    {0, 1, 2, 7, 11, 14, 17, 19},
	    {0, 1, 3, 5, 11, 14, 18, 19},
	    {0, 1, 3, 6, 10, 11, 17, 19},
	    {0, 1, 3, 7, 9, 14, 18, 19},
	    {0, 1, 3, 7, 11, 12, 17, 19},
	    {0, 1, 3, 7, 11, 16, 18, 19},
	    {0, 1, 3, 7, 12, 16, 18, 19},
	    {0, 1, 3, 8, 10, 14, 18, 19},
	    {0, 1, 3, 8, 12, 16, 18, 19},
	    {0, 1, 3, 9, 12, 13, 17, 19},
	    {0, 1, 3, 9, 13, 14, 17, 19},
	    {0, 1, 4, 6, 12, 14, 15, 19},
	    {0, 1, 4, 6, 12, 16, 17, 19},
	    {0, 1, 4, 6, 13, 15, 18, 19},
	    {0, 1, 4, 10, 12, 16, 17, 19},
	    {0, 1, 5, 8, 14, 16, 18, 19},
	    {0, 1, 5, 9, 11, 16, 18, 19},
	    {0, 1, 5, 10, 12, 16, 18, 19},
	    {0, 1, 6, 8, 13, 16, 17, 19},
	    {0, 1, 6, 10, 14, 16, 17, 19},
	    {0, 2, 3, 5, 9, 13, 18, 19},
	    {0, 2, 3, 6, 11, 13, 18, 19},
	    {0, 2, 3, 7, 9, 15, 18, 19},
	    {0, 2, 3, 7, 11, 16, 17, 19},
	    {0, 2, 3, 7, 13, 14, 17, 19},
	    {0, 2, 3, 7, 13, 15, 18, 19},
	    {0, 2, 3, 8, 12, 13, 15, 19},
	    {0, 2, 3, 8, 12, 16, 17, 19},
	    {0, 2, 3, 9, 11, 14, 15, 19},
	    {0, 2, 3, 9, 11, 15, 16, 19},
	    {0, 2, 3, 9, 13, 14, 17, 19},
	    {0, 2, 5, 6, 10, 16, 17, 19},
	    {0, 2, 5, 6, 12, 14, 15, 19},
	    {0, 2, 5, 6, 12, 16, 17, 19},
	    {0, 2, 5, 6, 13, 14, 17, 19},
	    {0, 2, 5, 8, 12, 17, 18, 19},
	    {0, 2, 6, 7, 10, 16, 18, 19},
	    {0, 2, 6, 9, 14, 15, 16, 19},
	    {0, 2, 6, 9, 14, 17, 18, 19},
	    {0, 2, 6, 11, 14, 17, 18, 19},
	    {0, 2, 7, 8, 12, 16, 18, 19},
	    {0, 2, 7, 10, 13, 17, 18, 19},
	    {0, 2, 8, 9, 13, 16, 18, 19},
	    {0, 3, 4, 5, 10, 13, 17, 19},
	    {0, 3, 4, 8, 10, 16, 17, 19},
	    {0, 3, 7, 9, 14, 17, 18, 19},
	    {0, 3, 8, 10, 14, 17, 18, 19},
	    {0, 4, 5, 7, 13, 14, 17, 19},
	    {0, 4, 5, 7, 13, 15, 18, 19},
	    {0, 4, 5, 8, 10, 16, 17, 19},
	    {0, 4, 6, 7, 11, 16, 17, 19},
	    {0, 4, 6, 11, 14, 17, 18, 19},
	    {0, 1, 3, 10, 14, 16, 19, 20},
    };
#elif(TAGLEN==1)
  const char rulers[64][16] = {
        {0, 1, 2, 4, 6, 7, 10, 11, 13, 15, 16, 17, 18, 20, 21},
        {0, 1, 2, 3, 6, 7, 9, 10, 12, 14, 16, 17, 18, 20, 21},
        {0, 1, 2, 4, 6, 7, 9, 12, 13, 14, 16, 17, 18, 20, 21},
        {0, 1, 2, 4, 5, 7, 9, 10, 11, 14, 15, 17, 19, 20, 21},
        {0, 1, 2, 4, 5, 8, 10, 11, 13, 14, 15, 17, 19, 20, 21},
        {0, 1, 3, 4, 5, 7, 10, 11, 12, 14, 16, 17, 19, 20, 21},
        {0, 1, 2, 4, 7, 8, 9, 11, 12, 14, 16, 17, 19, 20, 21},
        {0, 1, 2, 3, 5, 6, 8, 9, 10, 13, 14, 16, 18, 20, 21},
        {0, 1, 3, 4, 5, 7, 10, 11, 12, 14, 15, 17, 19, 20, 21},
        {0, 1, 2, 4, 5, 6, 8, 11, 12, 13, 15, 16, 18, 20, 21},
        {0, 1, 3, 5, 6, 8, 9, 12, 13, 14, 15, 17, 19, 20, 21},
        {0, 1, 2, 4, 5, 7, 8, 9, 11, 13, 14, 17, 19, 20, 21},
        {0, 1, 3, 4, 6, 9, 10, 11, 13, 15, 16, 17, 19, 20, 21},
        {0, 1, 2, 4, 5, 7, 9, 11, 12, 15, 16, 18, 19, 20, 21},
        {0, 1, 4, 5, 6, 8, 9, 11, 12, 14, 16, 18, 19, 20, 21},
        {0, 1, 2, 5, 6, 8, 10, 12, 13, 15, 16, 18, 19, 20, 21},
        {0, 1, 3, 5, 6, 7, 9, 10, 11, 14, 16, 17, 19, 20, 21},
        {0, 1, 3, 4, 6, 8, 9, 10, 12, 15, 16, 17, 19, 20, 21},
        {0, 1, 3, 4, 6, 8, 10, 11, 12, 13, 16, 17, 19, 20, 21},
        {0, 1, 2, 5, 7, 8, 9, 11, 12, 13, 15, 17, 18, 20, 21},
        {0, 1, 2, 4, 5, 7, 9, 11, 12, 15, 16, 17, 18, 20, 21},
        {0, 1, 2, 4, 5, 7, 9, 10, 11, 13, 14, 15, 18, 20, 21},
        {0, 1, 2, 3, 6, 7, 8, 10, 11, 13, 15, 17, 18, 20, 21},
        {0, 1, 2, 4, 5, 7, 8, 10, 12, 13, 14, 17, 19, 20, 21},
        {0, 1, 2, 4, 6, 7, 9, 10, 12, 13, 14, 17, 19, 20, 21},
        {0, 1, 2, 4, 5, 6, 8, 10, 11, 13, 16, 17, 19, 20, 21},
        {0, 1, 2, 5, 6, 7, 9, 11, 12, 14, 15, 17, 18, 19, 21},
        {0, 1, 2, 4, 5, 7, 9, 10, 12, 13, 14, 17, 19, 20, 21},
        {0, 1, 2, 5, 7, 8, 9, 11, 12, 14, 16, 17, 18, 20, 21},
        {0, 1, 2, 4, 6, 7, 9, 10, 11, 13, 16, 17, 19, 20, 21},
        {0, 1, 2, 4, 6, 7, 8, 10, 11, 14, 16, 17, 19, 20, 21},
        {0, 1, 3, 5, 7, 8, 10, 11, 13, 14, 15, 18, 19, 20, 21},
        {0, 1, 2, 3, 5, 6, 9, 10, 12, 14, 16, 17, 19, 20, 21},
        {0, 1, 2, 3, 6, 7, 8, 10, 11, 13, 14, 16, 18, 20, 21},
        {0, 1, 3, 4, 6, 7, 8, 11, 12, 14, 16, 18, 19, 20, 21},
        {0, 1, 2, 5, 7, 8, 10, 11, 12, 14, 15, 16, 18, 20, 21},
        {0, 1, 2, 4, 6, 7, 9, 10, 13, 14, 15, 17, 19, 20, 21},
        {0, 2, 3, 4, 6, 8, 9, 11, 12, 14, 15, 16, 19, 20, 21},
        {0, 1, 4, 5, 6, 7, 9, 10, 12, 13, 15, 17, 19, 20, 21},
        {0, 1, 2, 3, 6, 7, 9, 10, 12, 13, 14, 16, 18, 20, 21},
        {0, 1, 2, 4, 6, 7, 8, 9, 12, 13, 15, 17, 18, 20, 21},
        {0, 1, 2, 4, 5, 7, 8, 10, 11, 12, 14, 16, 19, 20, 21},
        {0, 1, 2, 5, 7, 8, 10, 11, 13, 15, 16, 17, 19, 20, 21},
        {0, 1, 2, 4, 6, 8, 9, 12, 13, 15, 16, 18, 19, 20, 21},
        {0, 1, 3, 5, 6, 9, 10, 11, 12, 14, 16, 17, 18, 20, 21},
        {0, 1, 2, 3, 5, 6, 8, 10, 12, 13, 16, 17, 19, 20, 21},
        {0, 1, 2, 3, 6, 7, 9, 11, 13, 14, 16, 17, 18, 20, 21},
        {0, 1, 3, 5, 6, 8, 10, 11, 12, 14, 15, 18, 19, 20, 21},
        {0, 1, 3, 5, 6, 7, 9, 12, 13, 14, 16, 17, 19, 20, 21},
        {0, 1, 3, 4, 5, 6, 9, 10, 12, 13, 15, 17, 19, 20, 21},
        {0, 1, 2, 3, 5, 7, 8, 10, 11, 12, 14, 16, 17, 20, 21},
        {0, 1, 2, 3, 5, 6, 8, 9, 12, 13, 14, 16, 18, 20, 21},
        {0, 1, 3, 6, 7, 8, 10, 11, 12, 14, 15, 17, 19, 20, 21},
        {0, 1, 3, 5, 7, 8, 10, 11, 12, 15, 16, 18, 19, 20, 21},
        {0, 1, 3, 5, 7, 8, 10, 11, 14, 15, 16, 18, 19, 20, 21},
        {0, 1, 3, 5, 6, 9, 10, 12, 13, 14, 15, 17, 19, 20, 21},
        {0, 1, 2, 4, 5, 6, 8, 11, 12, 13, 15, 17, 18, 20, 21},
        {0, 1, 3, 4, 5, 8, 9, 11, 12, 14, 16, 18, 19, 20, 21},
        {0, 1, 2, 5, 6, 7, 9, 10, 12, 13, 15, 17, 19, 20, 21},
        {0, 1, 2, 3, 5, 7, 9, 10, 12, 13, 16, 17, 18, 20, 21},
        {0, 1, 2, 5, 6, 8, 10, 11, 13, 14, 15, 17, 19, 20, 21},
        {0, 1, 2, 5, 7, 8, 10, 12, 13, 14, 16, 17, 19, 20, 21},
        {0, 1, 2, 3, 6, 7, 9, 11, 12, 14, 15, 16, 18, 20, 21},
        {0, 1, 3, 4, 5, 7, 9, 10, 11, 13, 14, 16, 19, 20, 21},
    };
#endif

// define the parametrization as used in paper
#if(TAGLEN==1)
    #define MAX_HISTORY 21
    #define PRO_BITS 8 
    #define IMM_BITS 0
    #define ORDER 16
#elif(TAGLEN==2)
    #define MAX_HISTORY 20
    #define PRO_BITS 16
    #define IMM_BITS 0
    #define ORDER = 8
#elif(TAGLEN==4)
    #define MAX_HISTORY 15
    #define PRO_BITS 16
    #define IMM_BITS 16
    #define ORDER 7
#endif

// input to hash function
typedef struct __attribute__((__packed__)) {
    uint32_t counter;
    unsigned char msg[MSGLEN];
} input_t;

// ring buffer of next tags
typedef struct __attribute__((__packed__)) {
    unsigned char tag[MAX_HISTORY][TAGLEN];
} state_t;


input_t tx_input, rx_input;
state_t tx_state, rx_state;

//pointer to current tag in the state ringbuffers
int curr_tx_tag = 0, curr_rx_tag = 0;

dtls_hmac_context_t* ctx;

unsigned char spmac_key[32];

unsigned char temp[32];

// length of tags
int len;

// store the selection of rulers for this instance of SPMAC
int selection[PRO_BITS] = {-1};

void spmac_init(unsigned char* key, int taglen){
    
    tx_input.counter = rand();
    rx_input.counter = tx_input.counter;
   
    memcpy( spmac_key, key, 32 );

    ctx = dtls_hmac_new( key, 32 );
    dtls_hmac_init(ctx, spmac_key, 32);

    len = taglen;

    int i,j;
    for(i=0; i<MAX_HISTORY; i++){
	    for(j=0; j<TAGLEN; j++){
            unsigned char temp = rand();	    
            tx_state.tag[i][j] = temp;
            rx_state.tag[i][j] = temp;
	    }
	}

    // selection PRO_BITS unique rulers
    i = 0;
    while(i<PRO_BITS){
      int cand = rand() % 64;
      for(j=0; j<i; j++){
          if(selection[j] == cand){
              continue;
          }
      }  
      selection[i] = cand;
      i += 1;
    }
}

void spmac_update_state(state_t* state, unsigned char* mac, int curr_tag){
    
    int macbit, ruler, n, offset;
    for( macbit=PRO_BITS+IMM_BITS; macbit<128; macbit++ ){ // the bits for this output tag are already consumed 
        
        ruler = macbit % (TAGLEN*8);
        n = (macbit-IMM_BITS) / PRO_BITS;
        
        offset = rulers[ruler][n];
        state->tag[(curr_tag + offset) % MAX_HISTORY][ruler/8] ^= mac[macbit/8] & (1<<(macbit%8));
    }
}

void spmac_sign(unsigned char* msg, unsigned char* output, rtimer_clock_t* end_live){

    memcpy(tx_input.msg, msg, MSGLEN);
            
    dtls_hmac_update(ctx, (unsigned char*) &tx_input, 4+MSGLEN);
    dtls_hmac_finalize(ctx, temp);
    
    int i;
    for(i=0; i<TAGLEN; i++){
        output[i] = temp[i] ^ tx_state.tag[curr_tx_tag][i];
        tx_state.tag[curr_tx_tag][i] = 0; // reset the bits to remove dependencies on older msgs    
    }

    *end_live = RTIMER_NOW();
    
    spmac_update_state(&tx_state, temp, curr_tx_tag);
    tx_input.counter += 1;
    curr_tx_tag = (curr_tx_tag + 1)%MAX_HISTORY;
    dtls_hmac_init(ctx, spmac_key, 32);
}

int spmac_vrfy(unsigned char* msg, unsigned char* sig){
    
    unsigned char tag[TAGLEN];

    memcpy(rx_input.msg, msg, MSGLEN);
            
    dtls_hmac_update(ctx, (unsigned char*) &rx_input, 4+MSGLEN);
    dtls_hmac_finalize(ctx, temp);
    
    int i;
    for(i=0; i<TAGLEN; i++){
        tag[i] = temp[i] ^ rx_state.tag[curr_rx_tag][i];    
    }
 
    spmac_update_state(&rx_state, temp, curr_rx_tag);
    rx_input.counter += 1;
    curr_rx_tag = (curr_rx_tag + 1)%MAX_HISTORY;
    dtls_hmac_init(ctx, spmac_key, 32);

    return memcmp( sig, tag, len );
}

void spmac_deinit(){

    dtls_hmac_free(ctx);
}
